# Ant Design CSS Token VS Code 插件 — 开发计划

## 一、项目概述

### 项目目标

开发一款 VS Code 插件，使 Ant Design CSS Token 在代码中变得「可见、可理解、可操作」。

### 核心价值

- **可视化**：颜色直接体现，无需 hover
- **可发现**：智能补全，降低记忆成本
- **可理解**：语义与来源清晰
- **低侵入**：符合 VS Code 原生编辑体验

---

## 二、技术架构设计

### 2.1 核心模块划分

```
antd-css-tokens/
├── src/
│   ├── extension.ts              # 插件入口
│   ├── providers/                # 功能提供者
│   │   ├── colorDecorator.ts     # 颜色装饰器
│   │   ├── hoverProvider.ts      # Hover 信息提供
│   │   ├── completionProvider.ts # 自动补全提供
│   │   └── definitionProvider.ts # 定义跳转（可选）
│   ├── tokenManager/             # Token 管理核心
│   │   ├── tokenRegistry.ts      # Token 注册表
│   │   ├── tokenParser.ts        # Token 解析器
│   │   ├── themeManager.ts       # 主题管理
│   │   └── sourceLoader.ts       # 数据源加载器
│   ├── data/                     # 静态数据
│   │   ├── antdTokens.ts         # AntD 官方 Token 数据
│   │   └── tokenMetadata.ts      # Token 元数据（语义说明）
│   ├── utils/                    # 工具函数
│   │   ├── cssParser.ts          # CSS 解析工具
│   │   ├── colorUtils.ts         # 颜色转换工具
│   │   └── fileWatcher.ts        # 文件监听工具
│   └── test/
│       ├── suite/
│       │   ├── colorDecorator.test.ts
│       │   ├── hoverProvider.test.ts
│       │   └── completionProvider.test.ts
│       └── extension.test.ts
├── package.json
├── tsconfig.json
└── README.md
```

### 2.2 技术选型

| 技术项       | 选择                      | 说明                |
| ------------ | ------------------------- | ------------------- |
| **开发语言** | TypeScript                | 类型安全，易维护    |
| **CSS 解析** | PostCSS / css-tree        | 解析 CSS 变量定义   |
| **正则匹配** | Native RegExp             | 识别 `var(--ant-*)` |
| **颜色处理** | color / tinycolor2        | 颜色格式转换        |
| **文件监听** | VS Code FileSystemWatcher | 监听 token 文件变更 |
| **缓存策略** | Map + LRU                 | 避免重复解析        |

### 2.3 关键技术点

#### 颜色装饰实现

```typescript
// 使用 TextEditorDecorationType
const colorDecorationType = vscode.window.createTextEditorDecorationType({
  before: {
    // 使用 before/after 伪元素展示颜色块
  }
});
```

#### Token 识别正则

```typescript
const CSS_VAR_PATTERN = /var\(\s*(--ant-[a-zA-Z0-9-]+)\s*\)/g;
```

#### Hover 内容格式

```typescript
new vscode.Hover(
  new vscode.MarkdownString(`
**Token**: \`--ant-color-primary\`
**Light**: \`#1677ff\`
**Dark**: \`#177ddc\`
**来源**: Ant Design 官方
`)
);
```

---

## 三、开发阶段规划

### 阶段 0：项目初始化 ✅

**时间**: 1 天
**状态**: 已完成

- [x] 创建 VS Code 扩展项目脚手架
- [x] 配置 TypeScript + ESLint
- [x] 设置项目结构
- [x] 编写基础 README

---

### 阶段 1：Token 数据层（Week 1）

**目标**: 建立 Token 数据管理基础设施

#### 任务清单

- [ ] **Task 1.1**: 整理 Ant Design v5 官方 Token 数据
  - 收集所有 `--ant-color-*` 相关 token
  - 收集 Light / Dark 主题对应值
  - 整理 token 语义说明
  - 输出为 TypeScript 类型定义 + JSON 数据

- [ ] **Task 1.2**: 实现 TokenRegistry（Token 注册表）

  ```typescript
  interface TokenInfo {
    name: string; // --ant-color-primary
    value: string; // #1677ff
    theme: 'light' | 'dark';
    category: string; // color / bg / text
    description?: string; // 主色
    source: 'builtin' | 'custom';
  }

  class TokenRegistry {
    register(token: TokenInfo): void;
    get(name: string, theme?: string): TokenInfo | undefined;
    getByCategory(category: string): TokenInfo[];
    getAllTokenNames(): string[];
  }
  ```

- [ ] **Task 1.3**: 实现 ThemeManager（主题管理器）
  - 管理当前激活主题（Light / Dark）
  - 支持手动切换主题
  - 监听 VS Code 主题变化事件
  - 提供主题变化回调机制

#### 验收标准

- 至少收集 100+ Ant Design 官方 token
- TokenRegistry 单元测试覆盖率 > 90%
- 可正确获取指定主题下的 token 值

---

### 阶段 2：颜色可视化（Week 2-3）

**目标**: 实现核心功能 - CSS Token 颜色装饰

#### 任务清单

- [ ] **Task 2.1**: 实现 CSS Token 扫描器
  - 使用正则匹配 `var(--ant-*)`
  - 提取 token 名称和位置范围
  - 支持多种文件类型（CSS / Less / Sass）
  - 实现增量扫描（仅扫描变更部分）

- [ ] **Task 2.2**: 实现 ColorDecorator（颜色装饰器）

  ```typescript
  class ColorDecorator {
    // 为匹配到的 token 添加颜色装饰
    decorate(editor: vscode.TextEditor, tokens: TokenMatch[]): void;

    // 清除装饰
    clear(editor: vscode.TextEditor): void;

    // 更新装饰（主题切换时）
    refresh(): void;
  }
  ```

- [ ] **Task 2.3**: 实现装饰样式
  - 设计颜色块展示方案（背景色 / 下划线 / 左侧色块）
  - 确保与 VS Code 原生颜色展示一致
  - 适配 Light / Dark 编辑器主题
  - 支持用户自定义样式（可配置）

- [ ] **Task 2.4**: 集成到编辑器
  - 监听文档打开事件
  - 监听文档内容变更事件
  - 监听主题切换事件
  - 实现防抖优化（避免频繁刷新）

- [ ] **Task 2.5**: 性能优化
  - 实现 Token 解析结果缓存
  - 大文件分片处理
  - 可见区域优先装饰
  - 添加性能监控日志

#### 验收标准

- 打开包含 `var(--ant-color-primary)` 的 CSS 文件，能立即看到颜色
- 切换 VS Code 主题，颜色装饰自动更新
- 在 1000+ 行 CSS 文件中无明显卡顿
- 支持 CSS / Less / Sass / Scss 文件

---

### 阶段 3：Hover 信息提示（Week 3）

**目标**: 实现鼠标悬浮时的详细信息展示

#### 任务清单

- [ ] **Task 3.1**: 实现 HoverProvider

  ```typescript
  class AntdTokenHoverProvider implements vscode.HoverProvider {
    provideHover(
      document: vscode.TextDocument,
      position: vscode.Position,
      token: vscode.CancellationToken
    ): vscode.Hover | undefined;
  }
  ```

- [ ] **Task 3.2**: 设计 Hover 内容布局

  ```markdown
  **Token**: `--ant-color-primary`

  **当前主题 (Light)**: `#1677ff`

  **语义**: 品牌主色

  **来源**: Ant Design 官方

  ---

  **多主题对比**:

  - Light: `#1677ff` 🔵
  - Dark: `#177ddc` 🔵
  ```

- [ ] **Task 3.3**: 实现颜色预览
  - 在 Hover 中显示颜色块
  - 支持多主题颜色并排展示
  - 添加颜色格式选择（hex / rgb / hsl）

- [ ] **Task 3.4**: 注册 Hover Provider
  - 注册到 CSS / Less / Sass 文件
  - 仅在 `var(--ant-*)` 位置触发

#### 验收标准

- Hover 在 token 上能正确显示完整信息
- 颜色预览清晰可见
- 响应速度 < 100ms

---

### 阶段 4：自动补全（Week 4）

**目标**: 实现 CSS Token 的智能补全

#### 任务清单

- [ ] **Task 4.1**: 实现 CompletionProvider

  ```typescript
  class AntdTokenCompletionProvider implements vscode.CompletionItemProvider {
    provideCompletionItems(
      document: vscode.TextDocument,
      position: vscode.Position,
      token: vscode.CancellationToken,
      context: vscode.CompletionContext
    ): vscode.CompletionItem[];
  }
  ```

- [ ] **Task 4.2**: 实现触发逻辑
  - 在 `var(--` 后触发
  - 在 `--ant` 后触发
  - 支持模糊匹配

- [ ] **Task 4.3**: 设计 CompletionItem

  ```typescript
  const item = new vscode.CompletionItem(
    '--ant-color-primary',
    vscode.CompletionItemKind.Color
  );
  item.detail = '品牌主色';
  item.documentation = new vscode.MarkdownString(
    '**Light**: #1677ff\n**Dark**: #177ddc'
  );
  item.insertText = 'var(--ant-color-primary)';
  item.sortText = '0001'; // 控制排序
  ```

- [ ] **Task 4.4**: 实现分类与排序
  - 按 category 分组（color / bg / text / border / shadow）
  - 最近使用的 token 优先
  - 支持拼音首字母搜索

- [ ] **Task 4.5**: 注册 CompletionProvider
  - 注册到 CSS / Less / Sass 文件
  - 设置触发字符：`-`, `(`

#### 验收标准

- 输入 `var(--ant` 能弹出所有 ant token
- 输入 `var(--ant-color` 能过滤到颜色类 token
- 补全项显示颜色预览
- 选择后自动插入完整的 `var(--ant-xxx)` 格式

---

### 阶段 5：Token 数据源管理（Week 5）

**目标**: 支持多种 Token 数据来源

#### 任务清单

- [ ] **Task 5.1**: 实现 SourceLoader（数据源加载器）

  ```typescript
  interface TokenSource {
    type: 'builtin' | 'css' | 'js';
    load(): Promise<TokenInfo[]>;
  }

  class SourceLoader {
    loadFromBuiltin(): TokenInfo[];
    loadFromCSS(filePath: string): TokenInfo[];
    loadFromJS(filePath: string): TokenInfo[];
  }
  ```

- [ ] **Task 5.2**: 实现 CSS 文件解析
  - 使用 PostCSS 解析 `:root` 中的 CSS 变量
  - 提取变量名和值
  - 识别颜色类型变量

- [ ] **Task 5.3**: 实现 JS/TS 文件解析（可选）
  - 解析 `theme.token` 对象
  - 支持 JS / TS / JSON 格式

- [ ] **Task 5.4**: 实现文件监听
  - 监听用户配置的 token 文件变更
  - 自动重新加载 token 数据
  - 刷新编辑器装饰

- [ ] **Task 5.5**: 添加用户配置
  ```json
  {
    "antdToken.source": {
      "type": "enum",
      "default": "builtin",
      "enum": ["builtin", "css", "js"]
    },
    "antdToken.customTokenFile": {
      "type": "string",
      "description": "自定义 Token 文件路径"
    }
  }
  ```

#### 验收标准

- 支持从内置数据加载 token
- 支持从项目 CSS 文件加载 token
- 文件变更后自动刷新
- 自定义 token 能正常显示和补全

---

### 阶段 6：配置与优化（Week 6）

**目标**: 完善配置项，优化用户体验

#### 任务清单

- [ ] **Task 6.1**: 添加配置项

  ```json
  {
    "antdToken.enableColorDecorator": true,
    "antdToken.enableHover": true,
    "antdToken.enableCompletion": true,
    "antdToken.decoratorStyle": "background" | "underline" | "gutter",
    "antdToken.showMultiTheme": true,
    "antdToken.fileTypes": ["css", "less", "scss", "sass"]
  }
  ```

- [ ] **Task 6.2**: 实现配置热更新
  - 监听配置变更事件
  - 动态启用/禁用功能
  - 刷新装饰样式

- [ ] **Task 6.3**: 添加命令面板命令
  - `Ant Design: Refresh Tokens` - 刷新 token 数据
  - `Ant Design: Toggle Theme` - 切换主题预览
  - `Ant Design: Show Token List` - 显示所有 token

- [ ] **Task 6.4**: 性能监控与日志
  - 添加性能监控点
  - 记录关键操作日志
  - 提供调试模式配置

- [ ] **Task 6.5**: 错误处理
  - Token 解析失败提示
  - 文件读取错误处理
  - 网络请求超时处理（未来）

#### 验收标准

- 所有配置项生效
- 配置变更无需重启 VS Code
- 命令面板命令可正常执行
- 错误有友好提示

---

### 阶段 7：测试与文档（Week 7）

**目标**: 完善测试覆盖，编写文档

#### 任务清单

- [ ] **Task 7.1**: 单元测试
  - TokenRegistry 测试
  - ThemeManager 测试
  - ColorDecorator 测试
  - HoverProvider 测试
  - CompletionProvider 测试
  - 目标覆盖率 > 80%

- [ ] **Task 7.2**: 集成测试
  - 端到端装饰测试
  - 配置变更测试
  - 文件监听测试

- [ ] **Task 7.3**: 手动测试清单
  - [ ] 在不同 VS Code 主题下测试
  - [ ] 在不同文件类型中测试
  - [ ] 测试大文件性能
  - [ ] 测试多窗口场景
  - [ ] 测试配置项开关

- [ ] **Task 7.4**: 编写用户文档
  - README.md（功能介绍 + 使用说明）
  - CHANGELOG.md（版本记录）
  - 配置说明文档
  - GIF 动图演示

- [ ] **Task 7.5**: 编写开发者文档
  - 架构设计文档
  - API 文档
  - 贡献指南
  - 本地开发指南

#### 验收标准

- 单元测试通过率 100%
- 覆盖率 > 80%
- README 清晰易懂
- 包含使用演示 GIF

---

### 阶段 8：发布准备（Week 8）

**目标**: 准备发布到 VS Code Marketplace

#### 任务清单

- [ ] **Task 8.1**: 完善 package.json
  - 填写完整的元数据
  - 添加关键词（keywords）
  - 设置正确的 categories
  - 添加 icon 和 banner

- [ ] **Task 8.2**: 准备发布资源
  - 设计插件图标
  - 准备 README 截图和 GIF
  - 编写版本发布说明

- [ ] **Task 8.3**: 代码审查与优化
  - ESLint 检查无错误
  - 移除 console.log
  - 优化打包体积
  - 检查依赖安全性

- [ ] **Task 8.4**: 发布配置
  - 注册 Azure DevOps 账号
  - 创建 Publisher
  - 配置 CI/CD（可选）

- [ ] **Task 8.5**: 首次发布
  - 执行 `vsce package`
  - 测试 .vsix 安装
  - 执行 `vsce publish`
  - 验证市场页面

#### 验收标准

- 插件能成功发布到市场
- 市场页面显示正常
- 用户能搜索并安装
- 安装后功能正常

---

## 四、里程碑设置

| 里程碑             | 时间     | 交付物             |
| ------------------ | -------- | ------------------ |
| **M0: 项目初始化** | Week 0   | 项目脚手架 ✅      |
| **M1: MVP 核心**   | Week 1-3 | 颜色可视化 + Hover |
| **M2: 智能补全**   | Week 4   | 自动补全功能       |
| **M3: 数据源扩展** | Week 5   | 支持自定义 Token   |
| **M4: 完整版本**   | Week 6-7 | 配置完善 + 测试    |
| **M5: 正式发布**   | Week 8   | 发布到市场         |

---

## 五、风险评估与应对

### 风险 1：性能问题

- **风险描述**: 大文件中颜色装饰导致卡顿
- **应对方案**:
  - 实现增量更新
  - 可见区域优先渲染
  - 添加防抖和节流
  - 提供性能配置项

### 风险 2：Token 数据不完整

- **风险描述**: 官方 token 变更，数据过时
- **应对方案**:
  - 建立 token 更新机制
  - 支持用户自定义补充
  - 提供 token 数据更新提示

### 风险 3：多主题适配复杂

- **风险描述**: Ant Design 主题变量复杂，难以穷举
- **应对方案**:
  - MVP 阶段仅支持 Light/Dark
  - 后续版本支持自定义主题
  - 提供配置覆盖机制

### 风险 4：文件类型兼容性

- **风险描述**: Less/Sass 语法差异导致解析失败
- **应对方案**:
  - 使用正则匹配而非完整解析
  - 针对不同文件类型测试
  - 提供错误降级机制

---

## 六、质量保证

### 6.1 代码规范

- ESLint + Prettier 强制格式化
- 提交前自动 Lint 检查
- 使用 TypeScript 严格模式

### 6.2 测试策略

- 单元测试：核心逻辑模块
- 集成测试：功能端到端验证
- 手动测试：真实场景验证
- 性能测试：大文件压力测试

### 6.3 发布流程

1. 本地测试通过
2. 打包生成 .vsix
3. 本地安装验证
4. 发布到市场
5. 监控用户反馈

---

## 七、资源与时间安排

### 开发人力

- 1 名开发者全职投入
- 预计总工时：8 周（40 工作日）

### 关键时间节点

- Week 3：MVP 完成，内部可用
- Week 5：功能完整，开始内测
- Week 7：测试完成，准备发布
- Week 8：正式发布

### 后续维护

- 每月检查 Ant Design 更新
- 及时响应用户 Issue
- 每季度发布功能更新

---

## 八、成功指标

### 功能指标

- [x] 支持 100+ Ant Design 官方 token
- [ ] 支持 CSS/Less/Sass 三种文件类型
- [ ] Hover 响应时间 < 100ms
- [ ] 自动补全准确率 > 95%

### 性能指标

- [ ] 1000 行文件装饰时间 < 200ms
- [ ] 内存占用 < 50MB
- [ ] CPU 占用 < 5%

### 用户体验指标

- [ ] 插件安装后无需配置即可使用
- [ ] 与 VS Code 原生体验一致
- [ ] 错误提示清晰友好

### 发布指标（3 个月后）

- [ ] 安装量 > 1000
- [ ] 评分 > 4.0
- [ ] Issue 响应时间 < 3 天

---

## 九、后续演进规划（Post MVP）

### V1.1 - 增强体验

- Token 定义跳转（Go to Definition）
- Token 使用统计
- 硬编码颜色检测与建议

### V1.2 - 多主题支持

- 支持 Compact / Custom 主题
- 主题切换预览面板
- 多主题对比视图

### V1.3 - 代码重构能力

- 硬编码颜色 → Token 的 Code Action
- Token 批量重命名
- 未使用 Token 检测

### V2.0 - 完整生态

- 支持 JS/TS 中的 `theme.token.xxx`
- Component 与 Token 关联分析
- 设计规范校验
- 团队协作功能

---

## 十、附录

### 参考资料

- [VS Code Extension API](https://code.visualstudio.com/api)
- [Ant Design Token 文档](https://ant.design/docs/react/customize-theme-cn)
- [PostCSS 文档](https://postcss.org/)
- [color 库文档](https://github.com/Qix-/color)

### 相关插件研究

- Color Highlight
- IntelliSense for CSS class names
- Tailwind CSS IntelliSense

### 技术调研记录

- VS Code Decoration API 性能测试
- CSS 变量解析方案对比
- Token 数据结构设计

---

**文档版本**: v1.0
**创建日期**: 2026-01-30
**最后更新**: 2026-01-30
**维护者**: liuxin
